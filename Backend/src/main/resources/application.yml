# Configurazione base portfolio backend

spring:
  application:
    name: portfolio-backend

  # DataSource: usa DB_URL (default SQLite) oppure le variabili standard Spring.
  # Con Supabase pooler (porta 6543) aggiungi alla URL: &prepareThreshold=0 (compatibile PgBouncer/Hibernate).
  datasource:
    url: ${SPRING_DATASOURCE_URL:${DB_URL:jdbc:sqlite:../Database/portfolio.db}}
    username: ${SPRING_DATASOURCE_USERNAME:}
    password: ${SPRING_DATASOURCE_PASSWORD:}
    driver-class-name: ${SPRING_DATASOURCE_DRIVER_CLASS_NAME:org.sqlite.JDBC}

  # JPA/Hibernate: ddl-auto crea/aggiorna le tabelle dalle entity (es. password_reset_tokens).
  # update = crea tabelle mancanti e nuove colonne, non elimina dati (ok per dev/small prod).
  # In produzione con migrazioni (Flyway/Liquibase) usa: validate o none.
  jpa:
    hibernate:
      ddl-auto: validate

# ---------------------------------------------------------------------------
# CORS (origini consentite per richieste browser cross-origin)
# ---------------------------------------------------------------------------
# In SecurityConfig: se CORS_ALLOWED_ORIGINS è impostata in .env, viene usata;
# altrimenti le origini sono costruite da FRONTEND_URL + ADMIN_FRONTEND_URL (.env).
# Nessun URL hardcoded nel codice.
app:
  cors: {}

  # ---------------------------------------------------------------------------
  # Contatti (form + email)
  # ---------------------------------------------------------------------------
  contact:
    # Email dove ricevere le notifiche dei messaggi (obbligatoria per invio notifica)
    notification-email: ${APP_CONTACT_NOTIFICATION_EMAIL:}
    # Invia una risposta automatica al mittente del form (template contact-reply-email.html)
    send-reply-to-sender: ${APP_CONTACT_SEND_REPLY_TO_SENDER:true}

  # ---------------------------------------------------------------------------
  # Email queue (outbox): invio email affidabile con retry e persistenza su DB
  # ---------------------------------------------------------------------------
  email-queue:
    poll-ms: 5000
    batch-size: 10
    max-attempts: 8
    stale-lock-ms: 300000

  # ---------------------------------------------------------------------------
  # Data retention (cancellazione automatica dati vecchi)
  # ---------------------------------------------------------------------------
  data-retention:
    retention-days: 90
    cron: "0 0 2 * * ?"
    batch-size: 500

  # ---------------------------------------------------------------------------
  # Resend (invio email via API HTTPS, funziona su Render free tier)
  # Se RESEND_API_KEY è impostata, le notifiche contatti (e opz. reset password) usano Resend invece di SMTP.
  # ---------------------------------------------------------------------------
  resend:
    api-key: ${RESEND_API_KEY:}
    # Mittente: per test usa "Portfolio <onboarding@resend.dev>"; in produzione verifica il dominio su Resend e usa es. "Portfolio <noreply@tuodominio.com>"
    from-email: ${RESEND_FROM_EMAIL:}

  # ---------------------------------------------------------------------------
  # Password Reset (reset password via email)
  # ---------------------------------------------------------------------------
  password-reset:
    # Durata validità token di reset in minuti (default: 60 = 1 ora)
    token-expiration-minutes: 60
    # Cron per pulizia token scaduti (ogni giorno alle 3:00 AM)
    cleanup-cron: "0 0 3 * * ?"
    # URL dell'app admin per il link nella mail (deve essere la base dell'admin, es. https://admin.tuodomain.com o http://localhost:5173)
    frontend-url: ${ADMIN_FRONTEND_URL:}
    # Abilita invio email (false = solo log, true = invia email via SMTP)
    email-enabled: ${PASSWORD_RESET_EMAIL_ENABLED:true}
